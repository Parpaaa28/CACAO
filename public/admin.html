<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <title>Admin</title>
  <style>
    :root{
      --bg:#f7f4ef;
      --panel:#ffffff;
      --panel-2:#fbf7f2;
      --accent:#6c584c;
      --accent-2:#6c584c;
      --accent-soft:#e9e1d7;
      --text:#111111;
      --border:rgba(108,88,76,.35);
      --border-soft:rgba(108,88,76,.2);
      --white:#ffffff;
      --muted:#6e6259;
      --shadow:0 14px 34px rgba(108,88,76,.12);
    }
    *{box-sizing:border-box}
    body{font-family:'Montserrat',Segoe UI,Tahoma,sans-serif;margin:0;color:var(--text);background:var(--bg)}
    a{text-decoration:none;color:inherit}
    .page{max-width:1300px;margin:0 auto;padding:20px 16px}
    .topbar{background:#111;color:#fff;text-align:center;font-size:12px;letter-spacing:.3px;padding:8px 16px}
    header.top{position:sticky;top:0;z-index:60;background:var(--panel);border-bottom:1px solid var(--border);padding:0;display:block}
    .top .mainbar{max-width:1300px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:24px;padding:12px 16px}
    .top .brand{text-decoration:none;color:var(--accent);font-weight:700;letter-spacing:2px;text-transform:uppercase}
    .top .nav{display:flex;align-items:center;gap:20px;flex-wrap:wrap}
    .top .nav a{color:var(--text);font-weight:600;letter-spacing:.08em;text-transform:uppercase;font-size:12px}
    .top .nav-right{display:flex;align-items:center;gap:10px}
    .top .icon-only{width:34px;height:34px;border:1px solid var(--border);border-radius:50%;background:transparent;display:inline-flex;align-items:center;justify-content:center;color:var(--text);padding:0}
    .top .icon-only svg{width:18px;height:18px}
    .top .icon-only svg path,.top .icon-only svg circle,.top .icon-only svg rect{stroke:var(--border);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
    #nav-user{font-size:12px;letter-spacing:.06em;text-transform:uppercase;color:var(--accent-2)}

    .admin-layout{display:grid;grid-template-columns:220px 1fr;gap:20px;margin-top:18px}
    .sidebar{position:sticky;top:90px;border:1px solid var(--border-soft);padding:14px;border-radius:14px;background:var(--panel);height:fit-content;box-shadow:var(--shadow)}
    .sidebar h3{margin:0 0 10px 0;font-size:12px;text-transform:uppercase;letter-spacing:.14em;color:var(--muted)}
    .side-link{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;border:1px solid transparent;color:#2f2a27;font-size:13px}
    .side-link:hover{border-color:var(--border);background:#faf7f2}
    .side-link.is-active{border-color:var(--border);background:#f4efe8}

    .section{margin-bottom:24px}
    .admin-section{display:none}
    .admin-section.is-active{display:block}
    .section-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .section-title{font-size:16px;letter-spacing:.12em;text-transform:uppercase;margin:0}
    .section-sub{font-size:12px;color:var(--muted);margin:0}
    .card{border:1px solid var(--border-soft);border-radius:16px;padding:14px;background:var(--panel);box-shadow:var(--shadow)}
    .card.soft{background:var(--panel-2)}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}

    .stat-card{border:1px solid var(--border-soft);border-radius:16px;padding:14px;background:linear-gradient(180deg,#fff,#f8f5ef);box-shadow:var(--shadow)}
    .stat-label{font-size:11px;letter-spacing:.16em;text-transform:uppercase;color:var(--muted)}
    .stat-value{font-size:24px;font-weight:700;margin-top:6px}

    .summary-grid{margin-bottom:12px}
    .summary-card{border:1px solid var(--border-soft);border-radius:14px;padding:12px;background:var(--panel-2);display:flex;flex-direction:column;gap:6px}
    .summary-label{font-size:10px;letter-spacing:.14em;text-transform:uppercase;color:var(--muted)}
    .summary-value{font-size:18px;font-weight:700}
    .summary-sub{font-size:11px;color:var(--muted)}

    .chart-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
    .chart-title{font-size:14px;font-weight:600}
    .line-chart{display:flex;flex-direction:column;gap:8px}
    .line-svg{width:100%;height:180px;display:block}
    .line-path{fill:none;stroke:var(--accent);stroke-width:3}
    .line-area{fill:rgba(108,88,76,.12)}
    .line-point{fill:var(--accent);stroke:#fff;stroke-width:2}
    .line-labels{display:grid;grid-template-columns:repeat(auto-fit,minmax(32px,1fr));gap:6px}
    .line-label{font-size:10px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);text-align:center}
    .line-value{font-size:10px;fill:var(--muted)}

    .status-list{display:flex;flex-direction:column;gap:10px}
    .status-row{display:grid;grid-template-columns:120px 1fr 40px;align-items:center;gap:10px;font-size:12px}
    .status-name{font-weight:600}
    .status-bar{height:8px;background:#f0e8df;border-radius:999px;overflow:hidden}
    .status-fill{display:block;height:100%;background:var(--accent);border-radius:999px}
    .status-value{text-align:right;font-weight:600}

    .mini-list{display:flex;flex-direction:column;gap:10px}
    .mini-item{border:1px solid var(--border-soft);border-radius:12px;padding:10px;background:var(--panel-2);display:flex;flex-direction:column;gap:4px}
    .mini-main{font-weight:600;font-size:13px}
    .mini-sub{font-size:11px;color:var(--muted)}

    .status-pill{display:inline-flex;align-items:center;padding:3px 8px;border-radius:999px;border:1px solid var(--border-soft);font-size:10px;text-transform:uppercase;letter-spacing:.12em;background:#f7f1e9}
    .status-pill[data-status="PENDING"]{background:#fff4d6}
    .status-pill[data-status="PAID"]{background:#e6f6e8}
    .status-pill[data-status="SHIPPED"]{background:#e7f0ff}
    .status-pill[data-status="DELIVERED"]{background:#e7f8f6}
    .status-pill[data-status="CANCELLED"]{background:#fde7e7}
    .status-control{display:flex;align-items:center;gap:8px}

    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px;border-bottom:1px solid rgba(108,88,76,.12);text-align:left;font-size:12px}
    th{font-size:11px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);background:#fbf7f2;position:sticky;top:0}
    tbody tr:nth-child(even){background:#faf7f2}
    tbody tr.is-late{background:#fff1ee}
    .table-wrap{overflow-x:auto;border-radius:12px}

    input,select,textarea,button{font-family:inherit}
    input,select,textarea{padding:9px 10px;border:1px solid var(--border-soft);border-radius:10px;width:100%;background:#fff}
    textarea{min-height:84px}
    .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--accent);cursor:pointer;color:var(--white);transition:transform .15s ease, box-shadow .15s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(108,88,76,.18)}
    .btn-secondary{background:var(--panel);color:var(--text)}
    .btn-ghost{background:#fff;border:1px dashed var(--border);color:var(--text)}
    .pill{display:inline-flex;align-items:center;padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:11px;text-transform:uppercase;letter-spacing:.12em}

    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
    .row-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    .notice{font-size:12px;color:#7a6f66}
    .tag{font-size:11px;text-transform:uppercase;letter-spacing:.14em;color:var(--muted)}

    @media (max-width: 980px){
      .admin-layout{grid-template-columns:1fr}
      .sidebar{position:static}
    }
  </style>
</head>
<body>
  <div class="topbar">Enjoy Free Local Shipping with a minimum spend of PHP 1,499</div>
  <header class="top">
    <div class="mainbar">
      <div class="brand">CACAO CENTRAL</div>
      <nav class="nav">
        <a href="/admin.html">Admin</a>
      </nav>
      <div class="nav-right">
        <a href="/login.html" id="nav-profile" class="icon-only" aria-label="Profile"><svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="8" r="4"></circle><path d="M4 20c1.5-4 5-6 8-6s6.5 2 8 6"></path></svg></a>
        <button id="nav-logout" class="icon-only" style="display:none" aria-label="Logout"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M10 5H5v14h5"></path><path d="M14 8l4 4-4 4"></path><path d="M18 12H9"></path></svg></button>
        <div id="nav-user" class="pill">Not logged in</div>
      </div>
    </div>
  </header>

  <div class="page admin-layout">
    <aside class="sidebar">
      <h3>Admin Panel</h3>
      <a class="side-link is-active" href="#dashboard" data-section="dashboard">Dashboard</a>
      <a class="side-link" href="#orders" data-section="orders">Orders</a>
      <a class="side-link" href="#inventory" data-section="inventory">Inventory</a>
      <a class="side-link" href="#products" data-section="products">Products</a>
      <a class="side-link" href="#promos" data-section="promos">Promos</a>
      <a class="side-link" href="#shipping" data-section="shipping">Shipping</a>
      <a class="side-link" href="#reviews" data-section="reviews">Reviews</a>
      <a class="side-link" href="#returns" data-section="returns">Returns</a>
      <a class="side-link" href="#users" data-section="users">Users</a>
      <a class="side-link" href="#content" data-section="content">Content</a>
      <a class="side-link" href="#reports" data-section="reports">Reports</a>
      <a class="side-link" href="#activity" data-section="activity">Activity</a>
    </aside>

    <main>
      <div id="status" class="notice"></div>

      <section id="dashboard" class="section admin-section is-active">
        <div class="section-head">
          <div>
            <h2 class="section-title">Dashboard</h2>
            <p class="section-sub">Overview of sales, orders, and inventory.</p>
          </div>
          <div class="row-actions">
            <label class="tag">Filter</label>
            <select id="dashboard-filter">
              <option value="1">Today</option>
              <option value="7" selected>Last 7 days</option>
              <option value="30">Last 30 days</option>
            </select>
          </div>
        </div>
        <div class="grid grid-3">
          <div class="stat-card"><div class="stat-label">Total Orders</div><div class="stat-value" id="stat-orders">0</div></div>
          <div class="stat-card"><div class="stat-label">Total Revenue</div><div class="stat-value" id="stat-revenue">PHP 0.00</div></div>
          <div class="stat-card"><div class="stat-label">Avg Order Value</div><div class="stat-value" id="stat-aov">PHP 0.00</div></div>
          <div class="stat-card"><div class="stat-label">Today Orders</div><div class="stat-value" id="stat-today">0</div></div>
          <div class="stat-card"><div class="stat-label">Pending Orders</div><div class="stat-value" id="stat-pending">0</div></div>
          <div class="stat-card"><div class="stat-label">Low Stock</div><div class="stat-value" id="stat-low">0</div></div>
        </div>
        <div id="period-summary" class="grid grid-3 summary-grid" style="margin-top:12px;"></div>
        <div class="grid grid-2" style="margin-top:14px;">
          <div class="card">
            <div class="chart-head">
              <div>
                <div class="tag">Sales Trend</div>
                <div class="chart-title">Last 7 days</div>
              </div>
            </div>
            <div id="sales-chart" class="line-chart"></div>
          </div>
          <div class="card">
            <div class="chart-head">
              <div>
                <div class="tag">Order Status</div>
                <div class="chart-title">Live distribution</div>
              </div>
            </div>
            <div id="status-chart" class="status-list">Loading...</div>
          </div>
        </div>
        <div class="grid grid-2" style="margin-top:14px;">
          <div class="card">
            <div class="chart-head">
              <div>
                <div class="tag">Catalog Mix</div>
                <div class="chart-title">Top categories</div>
              </div>
            </div>
            <div id="category-chart" class="status-list">Loading...</div>
          </div>
          <div class="card">
            <div class="chart-head">
              <div>
                <div class="tag">Recent Orders</div>
                <div class="chart-title">Latest 5</div>
              </div>
            </div>
            <div id="recent-orders" class="mini-list">Loading...</div>
          </div>
        </div>
        <div class="grid grid-2" style="margin-top:14px;">
          <div class="card">
            <div class="chart-head">
              <div>
                <div class="tag">Revenue</div>
                <div class="chart-title">By category</div>
              </div>
            </div>
            <div id="revenue-chart" class="status-list">Loading...</div>
          </div>
          <div class="card soft">
            <div class="chart-head">
              <div>
                <div class="tag">Alerts</div>
                <div class="chart-title">Low stock watch</div>
              </div>
            </div>
            <div id="low-stock-alert" class="mini-list">All good.</div>
          </div>
        </div>
        <div class="card" style="margin-top:14px;">
          <div class="chart-head">
            <div>
              <div class="tag">Top Products</div>
              <div class="chart-title">Best sellers</div>
            </div>
          </div>
          <div id="top-products" class="mini-list">Loading...</div>
        </div>
      </section>

      <section id="orders" class="section admin-section">
        <div class="section-head">
          <div>
            <h2 class="section-title">Orders</h2>
            <p class="section-sub">View and update order statuses.</p>
          </div>
        </div>
        <div id="orders-summary" class="grid grid-3 summary-grid"></div>
        <div class="card soft" style="margin-bottom:12px;">
          <div class="row-actions">
            <label class="tag">Bulk</label>
            <select id="bulk-status">
              <option value="">Set status...</option>
              <option value="PENDING">PENDING</option>
              <option value="PAID">PAID</option>
              <option value="SHIPPED">SHIPPED</option>
              <option value="DELIVERED">DELIVERED</option>
              <option value="CANCELLED">CANCELLED</option>
            </select>
            <button class="btn" id="bulk-apply">Apply to selected</button>
            <label class="row-actions" style="margin-left:auto;font-size:12px;color:var(--muted);">
              <input type="checkbox" id="orders-select-all"> Select all
            </label>
          </div>
          <div class="notice" style="margin-top:8px;">Late orders are highlighted automatically if they exceed SLA.</div>
        </div>
        <div class="card">
          <div id="orders-table" class="table-wrap">Loading...</div>
        </div>
      </section>

      <section id="inventory" class="section admin-section">
        <div class="section-head">
          <div>
            <h2 class="section-title">Inventory</h2>
            <p class="section-sub">Low stock alerts and quick updates.</p>
          </div>
        </div>
        <div id="inventory-summary" class="grid grid-3 summary-grid"></div>
        <div class="card">
          <div id="low-stock">Loading...</div>
        </div>
      </section>

      <section id="products" class="section admin-section">
        <div class="section-head">
          <div>
            <h2 class="section-title">Products</h2>
            <p class="section-sub">Add, edit, or remove products.</p>
          </div>
        </div>
        <div id="products-summary" class="grid grid-3 summary-grid"></div>
        <div class="card">
          <div class="tag">Add Product</div>
          <div class="form-grid" style="margin-top:8px">
            <input id="p-name" placeholder="Name" />
            <input id="p-price" type="number" placeholder="Price" />
            <input id="p-stock" type="number" placeholder="Stock" />
            <input id="p-category" placeholder="Category" />
            <input id="p-image" placeholder="Image URL" />
            <textarea id="p-desc" placeholder="Description"></textarea>
          </div>
          <div class="row-actions" style="margin-top:10px;">
            <button class="btn" id="p-add">Add Product</button>
            <div id="p-msg" class="notice"></div>
          </div>
        </div>
        <div class="card soft" style="margin-top:12px">
          <div class="tag">Import / Export</div>
          <div class="form-grid" style="margin-top:8px">
            <div>
              <div class="notice">Products CSV</div>
              <input type="file" id="import-products" accept=".csv" />
            </div>
            <div>
              <div class="notice">Inventory CSV</div>
              <input type="file" id="import-inventory" accept=".csv" />
            </div>
            <div class="row-actions">
              <button class="btn btn-secondary" id="export-products">Export Products CSV</button>
              <button class="btn btn-secondary" id="export-inventory">Export Inventory CSV</button>
            </div>
          </div>
          <div class="notice" style="margin-top:8px;">
            Headers for products: name, price, stock, category, image_url, description, tag_best_seller, tag_new, tag_limited
          </div>
          <div class="notice">Headers for inventory: name, stock</div>
        </div>
        <div class="card" style="margin-top:12px">
          <div class="tag">All Products</div>
          <div id="products-table" class="table-wrap" style="margin-top:8px;">Loading...</div>
        </div>
      </section>

      <section id="promos" class="section admin-section">
        <div class="section-head">
          <div>
            <h2 class="section-title">Promos</h2>
            <p class="section-sub">Create and activate promo codes.</p>
          </div>
        </div>
        <div id="promos-summary" class="grid grid-3 summary-grid"></div>
        <div class="card">
          <div class="form-grid">
            <input id="promo-code" placeholder="Code (e.g., SAVE10)" />
            <select id="promo-type">
              <option value="PERCENT">Percent</option>
              <option value="FIXED">Fixed</option>
            </select>
            <input id="promo-value" type="number" placeholder="Value" />
            <input id="promo-start" type="datetime-local" />
            <input id="promo-end" type="datetime-local" />
          </div>
          <div class="row-actions" style="margin-top:10px;">
            <button class="btn" id="promo-add">Save Promo</button>
            <div id="promo-msg" class="notice"></div>
          </div>
        </div>
        <div class="card" style="margin-top:12px">
          <div id="promos-table" class="table-wrap">Loading...</div>
        </div>
      </section>

      <section id="shipping" class="section admin-section">
        <div class="section-head">
          <div>
            <h2 class="section-title">Shipping Zones</h2>
            <p class="section-sub">Zones, fees, and ETA rules.</p>
          </div>
        </div>
        <div id="ship-summary" class="grid grid-3 summary-grid"></div>
        <div class="card">
          <div class="form-grid">
            <input id="ship-name" placeholder="Zone name" />
            <input id="ship-fee" type="number" placeholder="Fee (PHP)" />
            <input id="ship-eta" placeholder="ETA text" />
          </div>
          <div class="row-actions" style="margin-top:10px;">
            <button class="btn" id="ship-add">Add Zone</button>
            <div id="ship-msg" class="notice"></div>
          </div>
        </div>
        <div class="card" style="margin-top:12px">
          <div id="ship-table" class="table-wrap">Loading...</div>
        </div>
      </section>

      <section id="reviews" class="section admin-section">
        <div class="section-head">
          <div>
            <h2 class="section-title">Reviews</h2>
            <p class="section-sub">Approve or remove customer feedback.</p>
          </div>
        </div>
        <div id="reviews-summary" class="grid grid-3 summary-grid"></div>
        <div class="card">
          <div id="reviews-table" class="table-wrap">Loading...</div>
        </div>
      </section>

      <section id="returns" class="section admin-section">
        <div class="section-head">
          <div>
            <h2 class="section-title">Returns</h2>
            <p class="section-sub">Manage refund and return requests.</p>
          </div>
        </div>
        <div class="card">
          <div class="form-grid">
            <input id="return-order" placeholder="Order ID" />
            <input id="return-reason" placeholder="Reason" />
          </div>
          <div class="row-actions" style="margin-top:10px;">
            <button class="btn" id="return-add">Create Return</button>
            <div id="return-msg" class="notice"></div>
          </div>
        </div>
        <div class="card" style="margin-top:12px">
          <div id="returns-table" class="table-wrap">Loading...</div>
        </div>
      </section>

      <section id="users" class="section admin-section">
        <div class="section-head">
          <div>
            <h2 class="section-title">Users</h2>
            <p class="section-sub">Manage accounts and access.</p>
          </div>
        </div>
        <div id="users-summary" class="grid grid-3 summary-grid"></div>
        <div class="card">
          <div id="users-table" class="table-wrap">Loading...</div>
        </div>
        <div class="card soft" style="margin-top:12px">
          <div class="tag">Customer Profile</div>
          <div id="user-history" class="notice" style="margin-top:8px;">Select a user to view order history.</div>
        </div>
      </section>

      <section id="content" class="section admin-section">
        <div class="section-head">
          <div>
            <h2 class="section-title">Content Editor</h2>
            <p class="section-sub">Update homepage hero and promos.</p>
          </div>
        </div>
        <div class="card">
          <div class="form-grid">
            <input id="hero-title" placeholder="Hero title" />
            <input id="hero-sub" placeholder="Hero subtitle" />
            <textarea id="promo-list" placeholder="Promo messages (one per line)"></textarea>
          </div>
          <div class="row-actions" style="margin-top:10px;">
            <button class="btn" id="save-content">Save Content</button>
            <div id="content-msg" class="notice"></div>
          </div>
        </div>
      </section>

      <section id="reports" class="section admin-section">
        <div class="section-head">
          <div>
            <h2 class="section-title">Reports</h2>
            <p class="section-sub">Download sales data.</p>
          </div>
        </div>
        <div class="card">
          <button class="btn btn-secondary" id="download-csv">Download Orders CSV</button>
          <div class="notice" style="margin-top:8px;">Exports order data including totals and status.</div>
        </div>
      </section>

      <section id="activity" class="section admin-section">
        <div class="section-head">
          <div>
            <h2 class="section-title">Activity Log</h2>
            <p class="section-sub">Recent changes and actions.</p>
          </div>
        </div>
        <div class="card">
          <div id="activity-table" class="table-wrap">Loading...</div>
        </div>
      </section>
    </main>
  </div>

  <script src="/site.js"></script>
  <script>
    const statuses = ["PENDING","PAID","SHIPPED","DELIVERED","CANCELLED"];
    const adminState = {
      orders: [],
      products: [],
      role: "admin",
      filterDays: 7,
      revenueByCategory: []
    };

    async function requireAdminAccess(){
      const me = await requireLogin(false);
      if(!me){
        document.getElementById("status").textContent = "Please login first.";
        return null;
      }
      if(!me.is_admin){
        document.getElementById("status").textContent = "Admin only.";
        return null;
      }
      adminState.role = me.role || "admin";
      document.body.dataset.role = adminState.role;
      applyRoleUI();
      return me;
    }

    function fmt(n){ return formatPHP(n || 0); }

    function renderSummary(targetId, items){
      const el = document.getElementById(targetId);
      if(!el) return;
      el.innerHTML = items.map(item => `
        <div class="summary-card">
          <div class="summary-label">${item.label}</div>
          <div class="summary-value">${item.value}</div>
          ${item.sub ? `<div class="summary-sub">${item.sub}</div>` : ""}
        </div>
      `).join("");
    }

    function applyRoleUI(){
      const isAdmin = adminState.role === "admin";
      const adminOnlyIds = [
        "promo-code","promo-type","promo-value","promo-start","promo-end","promo-add",
        "ship-name","ship-fee","ship-eta","ship-add",
        "p-name","p-price","p-stock","p-category","p-image","p-desc","p-add",
        "save-content","hero-title","hero-sub","promo-list",
        "import-products"
      ];
      adminOnlyIds.forEach(id => {
        const el = document.getElementById(id);
        if(!el) return;
        el.disabled = !isAdmin;
        if(!isAdmin) el.title = "Admin only";
      });
      const contentSection = document.getElementById("content");
      if(contentSection && !isAdmin){
        const note = contentSection.querySelector(".role-note");
        if(!note){
          const p = document.createElement("p");
          p.className = "notice role-note";
          p.textContent = "Admin only: content updates are locked for staff accounts.";
          contentSection.prepend(p);
        }
      }
    }

    function parseCSV(text){
      const rows = [];
      let current = [];
      let value = "";
      let inQuotes = false;
      for(let i=0;i<text.length;i++){
        const char = text[i];
        const next = text[i+1];
        if(char === '"' && inQuotes && next === '"'){ value += '"'; i++; continue; }
        if(char === '"'){ inQuotes = !inQuotes; continue; }
        if(char === "," && !inQuotes){ current.push(value); value = ""; continue; }
        if((char === "\n" || char === "\r") && !inQuotes){
          if(value !== "" || current.length){ current.push(value); rows.push(current); }
          current = []; value = "";
          if(char === "\r" && next === "\n") i++;
          continue;
        }
        value += char;
      }
      if(value !== "" || current.length){ current.push(value); rows.push(current); }
      return rows.map(r => r.map(c => c.trim()));
    }

    function exportCSV(filename, headers, rows){
      const csv = [headers.join(",")].concat(
        rows.map(r => headers.map(h => `"${String(r[h] ?? "").replace(/"/g, '""')}"`).join(","))
      ).join("\n");
      const blob = new Blob([csv], { type:"text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function renderSalesChart(orders){
      const wrap = document.getElementById("sales-chart");
      if(!wrap) return;
      const today = new Date();
      today.setHours(0,0,0,0);
      const rangeDays = Math.max(1, Number(adminState.filterDays || 7));
      const days = Array.from({length:rangeDays}, (_,i) => {
        const d = new Date(today);
        d.setDate(d.getDate() - (rangeDays - 1) + i);
        return d;
      });
      const totals = days.map(d => {
        const start = new Date(d);
        const end = new Date(d);
        end.setDate(end.getDate() + 1);
        return orders
          .filter(o => {
            const t = new Date(o.created_at);
            return t >= start && t < end;
          })
          .reduce((sum, o) => sum + Number(o.total || 0), 0);
      });
      const max = Math.max(...totals, 1);
      const width = 600;
      const height = 180;
      const pad = 20;
      const step = (width - pad * 2) / (totals.length - 1 || 1);
      const points = totals.map((value, i) => {
        const x = pad + step * i;
        const y = height - pad - ((height - pad * 2) * (value / max));
        return { x, y, value };
      });
      const path = points.map((p, i) => `${i === 0 ? "M" : "L"}${p.x},${p.y}`).join(" ");
      const areaPath = `${path} L ${pad + step * (totals.length - 1)},${height - pad} L ${pad},${height - pad} Z`;
      const labels = days.map(d => {
        if(rangeDays <= 7) return d.toLocaleDateString("en-US", { weekday: "short" });
        return d.toLocaleDateString("en-US", { month: "short", day: "numeric" });
      });
      wrap.innerHTML = `
        <svg class="line-svg" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
          <path class="line-area" d="${areaPath}"></path>
          <path class="line-path" d="${path}"></path>
          ${points.map(p => `
            <circle class="line-point" cx="${p.x}" cy="${p.y}" r="5"></circle>
            <text class="line-value" x="${p.x}" y="${Math.max(p.y - 10, 14)}" text-anchor="middle">${fmt(p.value)}</text>
          `).join("")}
        </svg>
        <div class="line-labels">
          ${labels.map(label => `<div class="line-label">${label}</div>`).join("")}
        </div>
      `;
    }

    function renderStatusChart(orders){
      const wrap = document.getElementById("status-chart");
      if(!wrap) return;
      const total = orders.length || 1;
      const counts = statuses.reduce((acc, s) => {
        acc[s] = orders.filter(o => o.status === s).length;
        return acc;
      }, {});
      wrap.innerHTML = statuses.map(s => {
        const count = counts[s] || 0;
        const pct = Math.round((count / total) * 100);
        return `
          <div class="status-row">
            <div class="status-name">${s}</div>
            <div class="status-bar"><span class="status-fill" style="width:${pct}%"></span></div>
            <div class="status-value">${count}</div>
          </div>
        `;
      }).join("");
    }

    function renderCategoryChart(products){
      const wrap = document.getElementById("category-chart");
      if(!wrap) return;
      const map = {};
      products.forEach(p => {
        const key = (p.category || "Uncategorized").trim();
        map[key] = (map[key] || 0) + 1;
      });
      const entries = Object.entries(map).sort((a,b) => b[1] - a[1]).slice(0, 6);
      if(!entries.length){
        wrap.innerHTML = "<div class='notice'>No categories yet.</div>";
        return;
      }
      const max = entries[0][1] || 1;
      wrap.innerHTML = entries.map(([name, count]) => {
        const pct = Math.round((count / max) * 100);
        return `
          <div class="status-row">
            <div class="status-name">${name}</div>
            <div class="status-bar"><span class="status-fill" style="width:${pct}%"></span></div>
            <div class="status-value">${count}</div>
          </div>
        `;
      }).join("");
    }

    function renderRevenueByCategory(rows){
      const wrap = document.getElementById("revenue-chart");
      if(!wrap) return;
      if(!rows.length){
        wrap.innerHTML = "<div class='notice'>No sales yet.</div>";
        return;
      }
      const max = Math.max(...rows.map(r => Number(r.revenue || 0)), 1);
      wrap.innerHTML = rows.slice(0,6).map(r => {
        const pct = Math.round((Number(r.revenue || 0) / max) * 100);
        return `
          <div class="status-row">
            <div class="status-name">${r.category || "Uncategorized"}</div>
            <div class="status-bar"><span class="status-fill" style="width:${pct}%"></span></div>
            <div class="status-value">${fmt(r.revenue || 0)}</div>
          </div>
        `;
      }).join("");
    }

    function renderRecentOrders(orders){
      const wrap = document.getElementById("recent-orders");
      if(!wrap) return;
      const sorted = [...orders].sort((a,b) => new Date(b.created_at) - new Date(a.created_at)).slice(0,5);
      if(!sorted.length){
        wrap.innerHTML = "<div class='notice'>No orders yet.</div>";
        return;
      }
      wrap.innerHTML = sorted.map(o => `
        <div class="mini-item">
          <div class="mini-main">#${o.id} • ${o.user_name}</div>
          <div class="mini-sub">${fmt(o.total)} • ${o.status}</div>
        </div>
      `).join("");
    }

    function isLateOrder(order){
      if(!order || order.status === "DELIVERED" || order.status === "CANCELLED") return false;
      const created = Number(order.created_at || 0);
      if(!created) return false;
      const ageDays = (Date.now() - created) / (1000 * 60 * 60 * 24);
      return ageDays > 3;
    }

    function renderPeriodSummary(orders){
      const revenue = orders.reduce((sum, o) => sum + Number(o.total || 0), 0);
      const pending = orders.filter(o => o.status === "PENDING").length;
      const late = orders.filter(isLateOrder).length;
      renderSummary("period-summary", [
        { label: "Period Orders", value: orders.length },
        { label: "Period Revenue", value: fmt(revenue) },
        { label: "Late Orders", value: late, sub: "Over 3 days" }
      ]);
    }

    function renderLowStockAlert(products){
      const wrap = document.getElementById("low-stock-alert");
      if(!wrap) return;
      const low = products.filter(p => Number(p.stock || 0) <= 5);
      if(!low.length){
        wrap.innerHTML = "<div class='notice'>All good. No low stock.</div>";
        return;
      }
      wrap.innerHTML = low.slice(0,6).map(p => `
        <div class="mini-item">
          <div class="mini-main">${p.name}</div>
          <div class="mini-sub">Stock: ${p.stock}</div>
        </div>
      `).join("");
    }

    function getFilteredOrders(){
      const days = Number(adminState.filterDays || 7);
      const now = Date.now();
      const since = now - days * 24 * 60 * 60 * 1000;
      return adminState.orders.filter(o => Number(o.created_at || 0) >= since);
    }

    function renderDashboardAnalytics(){
      const filtered = getFilteredOrders();
      renderSalesChart(filtered);
      renderStatusChart(filtered);
      renderCategoryChart(adminState.products);
      renderRecentOrders(filtered);
      renderPeriodSummary(filtered);
    }

    async function loadStats(){
      const r = await fetch("/api/admin/stats");
      const j = await r.json();
      if(!j.ok) return;
      const s = j.data || {};
      document.getElementById("stat-orders").textContent = s.total_orders || 0;
      document.getElementById("stat-revenue").textContent = fmt(s.total_revenue || 0);
      const aov = s.total_orders ? (Number(s.total_revenue || 0) / Number(s.total_orders || 1)) : 0;
      document.getElementById("stat-aov").textContent = fmt(aov);
      document.getElementById("stat-today").textContent = s.today_orders || 0;
      document.getElementById("stat-pending").textContent = s.pending_orders || 0;
      document.getElementById("stat-low").textContent = s.low_stock || 0;
      const top = document.getElementById("top-products");
      const items = (s.top_products || []).map(p => `
        <div class="mini-item">
          <div class="mini-main">${p.name}</div>
          <div class="mini-sub">${p.qty} sold</div>
        </div>
      `);
      top.innerHTML = items.length ? items.join("") : "<div class='notice'>No data yet.</div>";
    }

    async function loadOrders(){
      const r = await fetch("/api/admin/orders");
      const j = await r.json();
      if(!j.ok){ document.getElementById("orders-table").textContent = "Error loading orders."; return; }
      const rows = j.data || [];
      adminState.orders = rows;
      renderSummary("orders-summary", [
        { label: "Total Orders", value: rows.length },
        { label: "Pending", value: rows.filter(o => o.status === "PENDING").length },
        { label: "Delivered", value: rows.filter(o => o.status === "DELIVERED").length }
      ]);
      renderDashboardAnalytics();
      loadRevenueByCategory();
      if(!rows.length){ document.getElementById("orders-table").textContent = "No orders yet."; return; }
      const html = `
        <table>
          <thead><tr>
            <th></th><th>Order</th><th>Customer</th><th>Total</th><th>Status</th><th>Date</th><th>Timeline</th>
          </tr></thead>
          <tbody>
            ${rows.map(o => `
              <tr class="${isLateOrder(o) ? "is-late" : ""}">
                <td><input type="checkbox" class="order-check" data-order="${o.id}"></td>
                <td>#${o.id}</td>
                <td>${o.user_name}<br><span class="notice">${o.user_email}</span></td>
                <td>${fmt(o.total)}</td>
                <td>
                  <div class="status-control">
                    <span class="status-pill" data-status="${o.status}">${o.status}</span>
                    <select data-status="${o.id}">
                      ${statuses.map(s => `<option value="${s}" ${s===o.status ? "selected":""}>${s}</option>`).join("")}
                    </select>
                  </div>
                  ${isLateOrder(o) ? `<div class="notice">Late order</div>` : ""}
                </td>
                <td>${new Date(o.created_at).toLocaleString()}</td>
                <td>
                  <button class="btn btn-secondary" data-timeline="${o.id}">View</button>
                  <div class="notice" id="timeline-${o.id}" style="margin-top:6px; display:none;"></div>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
      const wrap = document.getElementById("orders-table");
      wrap.innerHTML = html;
      const selectAll = document.getElementById("orders-select-all");
      if(selectAll) selectAll.checked = false;
      wrap.querySelectorAll("select[data-status]").forEach(sel => {
        sel.addEventListener("change", async () => {
          const row = sel.closest("tr");
          const pill = row ? row.querySelector(".status-pill") : null;
          if(pill){
            pill.textContent = sel.value;
            pill.setAttribute("data-status", sel.value);
          }
          await fetch(`/api/orders/${sel.dataset.status}/status`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ status: sel.value })
          });
          loadOrders();
        });
      });
      wrap.querySelectorAll("[data-timeline]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.timeline;
          const box = document.getElementById(`timeline-${id}`);
          if(!box) return;
          if(box.style.display === "block"){
            box.style.display = "none";
            return;
          }
          box.textContent = "Loading...";
          box.style.display = "block";
          const r = await fetch(`/api/admin/orders/${id}/timeline`);
          const j = await r.json();
          if(!j.ok){ box.textContent = "Failed to load timeline."; return; }
          const rows = j.data || [];
          if(!rows.length){ box.textContent = "No timeline yet."; return; }
          box.innerHTML = rows.map(t => {
            const time = new Date(t.created_at).toLocaleString();
            return `<div>${time} • ${t.status} ${t.note ? "- " + t.note : ""}</div>`;
          }).join("");
        });
      });
    }

    async function loadProducts(){
      const r = await fetch("/api/products");
      const j = await r.json();
      if(!j.ok){ document.getElementById("products-table").textContent = "Error loading products."; return; }
      const rows = j.data || [];
      const isAdmin = adminState.role === "admin";
      adminState.products = rows;
      const totalSkus = rows.length;
      const low = rows.filter(p => Number(p.stock || 0) <= 5);
      const out = rows.filter(p => Number(p.stock || 0) <= 0);
      const categoryCount = new Set(rows.map(p => (p.category || "").trim()).filter(Boolean)).size;
      const avgPrice = totalSkus ? (rows.reduce((sum, p) => sum + Number(p.price || 0), 0) / totalSkus) : 0;
      renderSummary("inventory-summary", [
        { label: "Total SKUs", value: totalSkus },
        { label: "Low Stock", value: low.length, sub: "≤ 5 units" },
        { label: "Out of Stock", value: out.length }
      ]);
      renderSummary("products-summary", [
        { label: "Categories", value: categoryCount },
        { label: "Avg Price", value: fmt(avgPrice) },
        { label: "Active Products", value: totalSkus - out.length }
      ]);
      renderDashboardAnalytics();
      document.getElementById("low-stock").innerHTML = low.length
        ? low.map(p => `${p.name} (Stock: ${p.stock})`).join("<br>")
        : "All stocks are healthy.";
      renderLowStockAlert(rows);

      const html = `
        <table>
          <thead><tr><th>Product</th><th>Price</th><th>Stock</th><th>Tags</th><th>Actions</th></tr></thead>
          <tbody>
            ${rows.map(p => `
              <tr>
                <td>${p.name}<br><span class="notice">${p.category || "-"}</span></td>
                <td><input data-price="${p.id}" type="number" value="${p.price}" ${isAdmin ? "" : "disabled"}></td>
                <td><input data-stock="${p.id}" type="number" value="${p.stock}"></td>
                <td>
                  <label class="notice"><input type="checkbox" data-tag="best" data-id="${p.id}" ${p.tag_best_seller ? "checked" : ""} ${isAdmin ? "" : "disabled"}> Best</label><br>
                  <label class="notice"><input type="checkbox" data-tag="new" data-id="${p.id}" ${p.tag_new ? "checked" : ""} ${isAdmin ? "" : "disabled"}> New</label><br>
                  <label class="notice"><input type="checkbox" data-tag="limited" data-id="${p.id}" ${p.tag_limited ? "checked" : ""} ${isAdmin ? "" : "disabled"}> Limited</label>
                </td>
                <td class="row-actions">
                  <button class="btn btn-secondary" data-save="${p.id}">Save</button>
                  ${isAdmin ? `<button class="btn btn-ghost" data-del="${p.id}">Delete</button>` : ""}
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
      const wrap = document.getElementById("products-table");
      wrap.innerHTML = html;
      wrap.querySelectorAll("button[data-save]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.save;
          const price = wrap.querySelector(`input[data-price="${id}"]`).value;
          const stock = wrap.querySelector(`input[data-stock="${id}"]`).value;
          if(isAdmin){
            const tag_best_seller = wrap.querySelector(`input[data-tag="best"][data-id="${id}"]`).checked;
            const tag_new = wrap.querySelector(`input[data-tag="new"][data-id="${id}"]`).checked;
            const tag_limited = wrap.querySelector(`input[data-tag="limited"][data-id="${id}"]`).checked;
            await fetch(`/api/products/${id}`, {
              method:"PUT",
              headers:{"Content-Type":"application/json"},
              body: JSON.stringify({ price, stock, tag_best_seller, tag_new, tag_limited })
            });
          }else{
            await fetch(`/api/admin/products/stock`, {
              method:"POST",
              headers:{"Content-Type":"application/json"},
              body: JSON.stringify({ id, stock })
            });
          }
          loadProducts();
        });
      });
      wrap.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", async () => {
          if(!confirm("Delete product?")) return;
          await fetch(`/api/products/${btn.dataset.del}`, { method:"DELETE" });
          loadProducts();
        });
      });
    }

    async function loadPromos(){
      const r = await fetch("/api/admin/promos");
      const j = await r.json();
      if(!j.ok){ document.getElementById("promos-table").textContent = "Error loading promos."; return; }
      const rows = j.data || [];
      const isAdmin = adminState.role === "admin";
      const active = rows.filter(p => p.active).length;
      renderSummary("promos-summary", [
        { label: "Total Codes", value: rows.length },
        { label: "Active", value: active },
        { label: "Inactive", value: rows.length - active }
      ]);
      document.getElementById("promos-table").innerHTML = `
        <table>
          <thead><tr><th>Code</th><th>Type</th><th>Value</th><th>Schedule</th><th>Active</th><th>Actions</th></tr></thead>
          <tbody>
            ${rows.map(p => `
              <tr>
                <td>${p.code}</td>
                <td>${p.type}</td>
                <td>${p.value}</td>
                <td>
                  <div class="notice">${p.start_at ? new Date(p.start_at).toLocaleDateString() : "Always on"}</div>
                  <div class="notice">${p.end_at ? new Date(p.end_at).toLocaleDateString() : "No end"}</div>
                </td>
                <td><span class="status-pill" data-status="${p.active ? "PAID" : "CANCELLED"}">${p.active ? "Active" : "Inactive"}</span></td>
                <td class="row-actions">
                  <button class="btn btn-secondary" data-toggle="${p.code}" ${isAdmin ? "" : "disabled"}>Toggle</button>
                  <button class="btn btn-ghost" data-del="${p.code}" ${isAdmin ? "" : "disabled"}>Delete</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
      document.querySelectorAll("[data-toggle]").forEach(btn => {
        btn.addEventListener("click", async () => {
          if(!isAdmin) return;
          await fetch(`/api/admin/promos/${btn.dataset.toggle}/toggle`, { method:"POST" });
          loadPromos();
        });
      });
      document.querySelectorAll("[data-del]").forEach(btn => {
        btn.addEventListener("click", async () => {
          if(!isAdmin) return;
          if(!confirm("Delete promo?")) return;
          await fetch(`/api/admin/promos/${btn.dataset.del}`, { method:"DELETE" });
          loadPromos();
        });
      });
    }

    async function loadShipping(){
      const r = await fetch("/api/admin/shipping-zones");
      const j = await r.json();
      if(!j.ok){ document.getElementById("ship-table").textContent = "Error loading zones."; return; }
      const rows = j.data || [];
      const isAdmin = adminState.role === "admin";
      const active = rows.filter(z => z.active).length;
      const avgFee = rows.length ? (rows.reduce((sum, z) => sum + Number(z.fee || 0), 0) / rows.length) : 0;
      renderSummary("ship-summary", [
        { label: "Zones", value: rows.length },
        { label: "Active Zones", value: active },
        { label: "Avg Fee", value: fmt(avgFee) }
      ]);
      document.getElementById("ship-table").innerHTML = `
        <table>
          <thead><tr><th>Zone</th><th>Fee</th><th>ETA</th><th>Active</th><th>Actions</th></tr></thead>
          <tbody>
            ${rows.map(z => `
              <tr>
                <td><input data-zname="${z.id}" value="${z.name}" ${isAdmin ? "" : "disabled"}></td>
                <td><input data-zfee="${z.id}" type="number" value="${z.fee}" ${isAdmin ? "" : "disabled"}></td>
                <td><input data-zeta="${z.id}" value="${z.eta_text}" ${isAdmin ? "" : "disabled"}></td>
                <td><input data-zactive="${z.id}" type="checkbox" ${z.active ? "checked" : ""} ${isAdmin ? "" : "disabled"}></td>
                <td class="row-actions">
                  <button class="btn btn-secondary" data-zsave="${z.id}" ${isAdmin ? "" : "disabled"}>Save</button>
                  <button class="btn btn-ghost" data-zdel="${z.id}" ${isAdmin ? "" : "disabled"}>Delete</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
      document.querySelectorAll("[data-zsave]").forEach(btn => {
        btn.addEventListener("click", async () => {
          if(!isAdmin) return;
          const id = btn.dataset.zsave;
          const name = document.querySelector(`[data-zname="${id}"]`).value;
          const fee = document.querySelector(`[data-zfee="${id}"]`).value;
          const eta = document.querySelector(`[data-zeta="${id}"]`).value;
          const active = document.querySelector(`[data-zactive="${id}"]`).checked;
          await fetch(`/api/admin/shipping-zones/${id}`, {
            method:"PUT",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ name, fee, eta_text: eta, active })
          });
          loadShipping();
        });
      });
      document.querySelectorAll("[data-zdel]").forEach(btn => {
        btn.addEventListener("click", async () => {
          if(!isAdmin) return;
          if(!confirm("Delete zone?")) return;
          await fetch(`/api/admin/shipping-zones/${btn.dataset.zdel}`, { method:"DELETE" });
          loadShipping();
        });
      });
    }

    async function loadReviews(){
      const r = await fetch("/api/admin/reviews");
      const j = await r.json();
      if(!j.ok){ document.getElementById("reviews-table").textContent = "Error loading reviews."; return; }
      const rows = j.data || [];
      const pending = rows.filter(r => !r.approved).length;
      const avgRating = rows.length ? (rows.reduce((sum, r) => sum + Number(r.rating || 0), 0) / rows.length) : 0;
      renderSummary("reviews-summary", [
        { label: "Total Reviews", value: rows.length },
        { label: "Pending", value: pending },
        { label: "Avg Rating", value: avgRating ? avgRating.toFixed(1) : "0.0" }
      ]);
      if(!rows.length){ document.getElementById("reviews-table").textContent = "No reviews yet."; return; }
      document.getElementById("reviews-table").innerHTML = `
        <table>
          <thead><tr><th>Product</th><th>Name</th><th>Rating</th><th>Review</th><th>Approved</th><th>Actions</th></tr></thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td>${r.product_name}</td>
                <td>${r.name}</td>
                <td>${"★".repeat(Number(r.rating || 0))}${"☆".repeat(5 - Number(r.rating || 0))}</td>
                <td>${r.text}</td>
                <td><input type="checkbox" data-rapp="${r.id}" ${r.approved ? "checked":""}></td>
                <td class="row-actions">
                  <button class="btn btn-secondary" data-rsave="${r.id}">Save</button>
                  <button class="btn btn-secondary" data-rapprove="${r.id}">Approve</button>
                  <button class="btn btn-ghost" data-rdeny="${r.id}">Deny</button>
                  <button class="btn btn-ghost" data-rdel="${r.id}">Delete</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
      document.querySelectorAll("[data-rsave]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.rsave;
          const approved = document.querySelector(`[data-rapp="${id}"]`).checked;
          await fetch(`/api/admin/reviews/${id}`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ approved })
          });
          loadReviews();
        });
      });
      document.querySelectorAll("[data-rapprove]").forEach(btn => {
        btn.addEventListener("click", async () => {
          await fetch(`/api/admin/reviews/${btn.dataset.rapprove}`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ approved: true })
          });
          loadReviews();
        });
      });
      document.querySelectorAll("[data-rdeny]").forEach(btn => {
        btn.addEventListener("click", async () => {
          await fetch(`/api/admin/reviews/${btn.dataset.rdeny}`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ approved: false })
          });
          loadReviews();
        });
      });
      document.querySelectorAll("[data-rdel]").forEach(btn => {
        btn.addEventListener("click", async () => {
          if(!confirm("Delete review?")) return;
          await fetch(`/api/admin/reviews/${btn.dataset.rdel}`, { method:"DELETE" });
          loadReviews();
        });
      });
    }

    async function loadReturns(){
      const r = await fetch("/api/admin/returns");
      const j = await r.json();
      if(!j.ok){ document.getElementById("returns-table").textContent = "Error loading returns."; return; }
      const rows = j.data || [];
      if(!rows.length){ document.getElementById("returns-table").textContent = "No return requests yet."; return; }
      document.getElementById("returns-table").innerHTML = `
        <table>
          <thead><tr><th>ID</th><th>Order</th><th>Reason</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td>#${r.id}</td>
                <td>#${r.order_id}</td>
                <td>${r.reason}</td>
                <td>
                  <select data-return-status="${r.id}">
                    ${["OPEN","APPROVED","DENIED","REFUNDED","CLOSED"].map(s => `<option value="${s}" ${s===r.status ? "selected":""}>${s}</option>`).join("")}
                  </select>
                </td>
                <td class="row-actions">
                  <button class="btn btn-secondary" data-return-save="${r.id}">Save</button>
                  <button class="btn btn-ghost" data-return-del="${r.id}">Delete</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
      document.querySelectorAll("[data-return-save]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.returnSave;
          const status = document.querySelector(`[data-return-status="${id}"]`).value;
          await fetch(`/api/admin/returns/${id}/status`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ status })
          });
          loadReturns();
        });
      });
      document.querySelectorAll("[data-return-del]").forEach(btn => {
        btn.addEventListener("click", async () => {
          if(!confirm("Delete return?")) return;
          await fetch(`/api/admin/returns/${btn.dataset.returnDel}`, { method:"DELETE" });
          loadReturns();
        });
      });
    }

    async function loadActivity(){
      const r = await fetch("/api/admin/activity");
      const j = await r.json();
      if(!j.ok){ document.getElementById("activity-table").textContent = "Error loading activity."; return; }
      const rows = j.data || [];
      if(!rows.length){ document.getElementById("activity-table").textContent = "No activity yet."; return; }
      document.getElementById("activity-table").innerHTML = `
        <table>
          <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Meta</th></tr></thead>
          <tbody>
            ${rows.map(a => `
              <tr>
                <td>${new Date(a.created_at).toLocaleString()}</td>
                <td>${a.user_name || "System"}</td>
                <td>${a.action}</td>
                <td class="notice">${(() => { try{ const obj = JSON.parse(a.meta || ""); return JSON.stringify(obj); }catch(e){ return a.meta || ""; } })()}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    async function loadRevenueByCategory(){
      const r = await fetch(`/api/admin/revenue-by-category?days=${adminState.filterDays || 7}`);
      const j = await r.json();
      if(!j.ok){ document.getElementById("revenue-chart").textContent = "Error loading revenue."; return; }
      adminState.revenueByCategory = j.data || [];
      renderRevenueByCategory(adminState.revenueByCategory);
    }

    async function loadUsers(){
      const r = await fetch("/api/admin/users");
      const j = await r.json();
      if(!j.ok){ document.getElementById("users-table").textContent = "Error loading users."; return; }
      const rows = j.data || [];
      const isAdmin = adminState.role === "admin";
      const admins = rows.filter(u => u.is_admin).length;
      const active = rows.filter(u => u.is_active).length;
      renderSummary("users-summary", [
        { label: "Total Users", value: rows.length },
        { label: "Admins", value: admins },
        { label: "Active", value: active }
      ]);
      document.getElementById("users-table").innerHTML = `
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Admin</th><th>Active</th><th>Actions</th></tr></thead>
          <tbody>
            ${rows.map(u => {
              const role = u.role || (u.is_admin ? "admin" : "customer");
              return `
              <tr>
                <td>${u.name}</td>
                <td>${u.email}</td>
                <td>
                  <select data-urole="${u.id}" ${isAdmin ? "" : "disabled"}>
                    <option value="admin" ${role === "admin" ? "selected" : ""}>Admin</option>
                    <option value="staff" ${role === "staff" ? "selected" : ""}>Staff</option>
                    <option value="customer" ${role === "customer" ? "selected" : ""}>Customer</option>
                  </select>
                </td>
                <td><input type="checkbox" data-uadmin="${u.id}" ${u.is_admin ? "checked":""} ${isAdmin ? "" : "disabled"}></td>
                <td><input type="checkbox" data-uactive="${u.id}" ${u.is_active ? "checked":""} ${isAdmin ? "" : "disabled"}></td>
                <td class="row-actions">
                  <button class="btn btn-secondary" data-usave="${u.id}" ${isAdmin ? "" : "disabled"}>Save</button>
                  <button class="btn btn-ghost" data-uview="${u.id}">View</button>
                </td>
              </tr>
            `}).join("")}
          </tbody>
        </table>
      `;
      document.querySelectorAll("[data-usave]").forEach(btn => {
        btn.addEventListener("click", async () => {
          if(!isAdmin) return;
          const id = btn.dataset.usave;
          const is_admin = document.querySelector(`[data-uadmin="${id}"]`).checked;
          const is_active = document.querySelector(`[data-uactive="${id}"]`).checked;
          const role = document.querySelector(`[data-urole="${id}"]`).value;
          await fetch(`/api/admin/users/${id}`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ is_admin, is_active, role })
          });
          loadUsers();
        });
      });
      document.querySelectorAll("[data-uview]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.uview;
          const r = await fetch(`/api/admin/users/${id}/orders`);
          const j = await r.json();
          const box = document.getElementById("user-history");
          if(!j.ok){ box.textContent = "Failed to load orders."; return; }
          const orders = j.data || [];
          if(!orders.length){ box.textContent = "No orders yet."; return; }
          box.innerHTML = orders.map(o => `
            <div class="mini-item">
              <div class="mini-main">#${o.id} • ${o.status}</div>
              <div class="mini-sub">${fmt(o.total)} • ${new Date(o.created_at).toLocaleDateString()}</div>
            </div>
          `).join("");
        });
      });
    }

    async function loadContent(){
      const r = await fetch("/api/admin/settings");
      const j = await r.json();
      if(!j.ok) return;
      const rows = j.data || [];
      const map = {};
      rows.forEach(r => { map[r.key] = r.value; });
      document.getElementById("hero-title").value = map.hero_title || "";
      document.getElementById("hero-sub").value = map.hero_sub || "";
      try{
        const promos = JSON.parse(map.promo_messages || "[]");
        document.getElementById("promo-list").value = Array.isArray(promos) ? promos.join("\n") : "";
      }catch(e){
        document.getElementById("promo-list").value = "";
      }
    }

    document.getElementById("p-add").addEventListener("click", async ()=>{
      if(adminState.role !== "admin"){
        alert("Admin only.");
        return;
      }
      const body = {
        name: document.getElementById("p-name").value.trim(),
        price: document.getElementById("p-price").value.trim(),
        stock: document.getElementById("p-stock").value.trim(),
        category: document.getElementById("p-category").value.trim(),
        image_url: document.getElementById("p-image").value.trim(),
        description: document.getElementById("p-desc").value.trim()
      };
      const r = await fetch("/api/products", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(body)
      });
      const j = await r.json();
      document.getElementById("p-msg").textContent = j.ok ? "Product added." : ("Error: " + (j.error || "failed"));
      if(j.ok){
        ["p-name","p-price","p-stock","p-category","p-image","p-desc"].forEach(id => {
          document.getElementById(id).value = "";
        });
        loadProducts();
      }
    });

    document.getElementById("promo-add").addEventListener("click", async ()=>{
      if(adminState.role !== "admin"){
        alert("Admin only.");
        return;
      }
      const code = document.getElementById("promo-code").value.trim();
      const type = document.getElementById("promo-type").value;
      const value = document.getElementById("promo-value").value.trim();
      const start = document.getElementById("promo-start").value;
      const end = document.getElementById("promo-end").value;
      const start_at = start ? new Date(start).getTime() : null;
      const end_at = end ? new Date(end).getTime() : null;
      const r = await fetch("/api/admin/promos", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ code, type, value, active: 1, start_at, end_at })
      });
      const j = await r.json();
      document.getElementById("promo-msg").textContent = j.ok ? "Promo saved." : ("Error: " + (j.error || "failed"));
      if(j.ok){
        document.getElementById("promo-code").value = "";
        document.getElementById("promo-value").value = "";
        document.getElementById("promo-start").value = "";
        document.getElementById("promo-end").value = "";
        loadPromos();
      }
    });

    document.getElementById("ship-add").addEventListener("click", async ()=>{
      if(adminState.role !== "admin"){
        alert("Admin only.");
        return;
      }
      const name = document.getElementById("ship-name").value.trim();
      const fee = document.getElementById("ship-fee").value.trim();
      const eta_text = document.getElementById("ship-eta").value.trim();
      const r = await fetch("/api/admin/shipping-zones", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ name, fee, eta_text, active: 1 })
      });
      const j = await r.json();
      document.getElementById("ship-msg").textContent = j.ok ? "Zone added." : ("Error: " + (j.error || "failed"));
      if(j.ok){ document.getElementById("ship-name").value = ""; document.getElementById("ship-fee").value = ""; document.getElementById("ship-eta").value = ""; loadShipping(); }
    });

    document.getElementById("return-add").addEventListener("click", async ()=>{
      const order_id = document.getElementById("return-order").value.trim();
      const reason = document.getElementById("return-reason").value.trim();
      const r = await fetch("/api/admin/returns", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ order_id, reason })
      });
      const j = await r.json();
      document.getElementById("return-msg").textContent = j.ok ? "Return created." : ("Error: " + (j.error || "failed"));
      if(j.ok){
        document.getElementById("return-order").value = "";
        document.getElementById("return-reason").value = "";
        loadReturns();
      }
    });

    document.getElementById("export-products").addEventListener("click", async ()=>{
      const r = await fetch("/api/products");
      const j = await r.json();
      if(!j.ok) return alert("Failed to export products.");
      const rows = j.data || [];
      const headers = ["name","price","stock","category","image_url","description","tag_best_seller","tag_new","tag_limited"];
      exportCSV("products.csv", headers, rows);
    });

    document.getElementById("export-inventory").addEventListener("click", async ()=>{
      const r = await fetch("/api/products");
      const j = await r.json();
      if(!j.ok) return alert("Failed to export inventory.");
      const rows = (j.data || []).map(p => ({ name: p.name, stock: p.stock }));
      const headers = ["name","stock"];
      exportCSV("inventory.csv", headers, rows);
    });

    document.getElementById("import-products").addEventListener("change", async (e)=>{
      if(adminState.role !== "admin"){
        alert("Admin only.");
        e.target.value = "";
        return;
      }
      const file = e.target.files[0];
      if(!file) return;
      const text = await file.text();
      const rows = parseCSV(text);
      const [header, ...data] = rows;
      const map = header.map(h => h.toLowerCase());
      const items = data.map(row => {
        const obj = {};
        map.forEach((h, idx) => { obj[h] = row[idx]; });
        return obj;
      }).filter(r => r.name);
      await fetch("/api/admin/products/bulk", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ items })
      });
      e.target.value = "";
      loadProducts();
    });

    document.getElementById("import-inventory").addEventListener("change", async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const text = await file.text();
      const rows = parseCSV(text);
      const [header, ...data] = rows;
      const map = header.map(h => h.toLowerCase());
      const items = data.map(row => {
        const obj = {};
        map.forEach((h, idx) => { obj[h] = row[idx]; });
        return obj;
      }).filter(r => r.name);
      await fetch("/api/admin/products/stock-bulk", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ items })
      });
      e.target.value = "";
      loadProducts();
    });

    document.getElementById("save-content").addEventListener("click", async ()=>{
      if(adminState.role !== "admin"){
        alert("Admin only.");
        return;
      }
      const hero_title = document.getElementById("hero-title").value.trim();
      const hero_sub = document.getElementById("hero-sub").value.trim();
      const promos = document.getElementById("promo-list").value.split("\n").map(x => x.trim()).filter(Boolean);
      await fetch("/api/admin/settings", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ key:"hero_title", value: hero_title }) });
      await fetch("/api/admin/settings", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ key:"hero_sub", value: hero_sub }) });
      await fetch("/api/admin/settings", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ key:"promo_messages", value: promos }) });
      document.getElementById("content-msg").textContent = "Content saved.";
    });

    document.getElementById("download-csv").addEventListener("click", async ()=>{
      const r = await fetch("/api/admin/orders");
      const j = await r.json();
      if(!j.ok){ alert("Failed to export."); return; }
      const rows = j.data || [];
      const headers = ["id","user_name","user_email","total","status","promo_code","discount","created_at"];
      const csv = [headers.join(",")].concat(rows.map(o => headers.map(h => `"${String(o[h] ?? "").replace(/"/g, '""')}"`).join(","))).join("\n");
      const blob = new Blob([csv], { type:"text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "orders.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    document.getElementById("orders-select-all").addEventListener("change", (e) => {
      document.querySelectorAll(".order-check").forEach(ch => {
        ch.checked = e.target.checked;
      });
    });

    document.getElementById("bulk-apply").addEventListener("click", async () => {
      const status = document.getElementById("bulk-status").value;
      if(!status) return alert("Select a status first.");
      const ids = Array.from(document.querySelectorAll(".order-check:checked")).map(ch => ch.dataset.order);
      if(!ids.length) return alert("Select at least one order.");
      await fetch("/api/admin/orders/bulk-status", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ ids, status })
      });
      loadOrders();
    });

    document.getElementById("dashboard-filter").addEventListener("change", (e) => {
      adminState.filterDays = Number(e.target.value || 7);
      renderDashboardAnalytics();
      loadRevenueByCategory();
    });

    async function boot(){
      const me = await requireAdminAccess();
      if(!me) return;
      const filterEl = document.getElementById("dashboard-filter");
      if(filterEl) adminState.filterDays = Number(filterEl.value || 7);
      await loadStats();
      await loadOrders();
      await loadProducts();
      await loadPromos();
      await loadShipping();
      await loadReviews();
      await loadReturns();
      await loadUsers();
      await loadContent();
      await loadRevenueByCategory();
      await loadActivity();
    }

    boot();

    function showSection(id){
      document.querySelectorAll(".admin-section").forEach(sec => {
        sec.classList.toggle("is-active", sec.id === id);
      });
      document.querySelectorAll(".side-link").forEach(link => {
        link.classList.toggle("is-active", link.dataset.section === id);
      });
    }

    document.querySelectorAll(".side-link").forEach(link => {
      link.addEventListener("click", (e) => {
        const id = link.dataset.section;
        if(!id) return;
        e.preventDefault();
        showSection(id);
      });
    });
  </script>
</body>
</html>
